---
title: "Map"
author: 'IRENE MARTINEZ MORATA (UNI: im2557)'
date: "12/7/2021"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(Hmisc)     
library(dplyr)
library(openxlsx)
library(readr)
library(spdep)
library(maptools)
library(rgdal)
library(spatialreg)
library(spgwr)
library(raster)



getwd()
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",

  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


```{r }

# read data    
map <- shapefile("shapefiles/geo_export_86448df9-5583-4b77-95f8-e16a45855071.shp")  

project_df <- read_csv("final_mod_zcta.csv")

map_df <- merge(map, project_df, by = 'modzcta', duplicateGeoms = TRUE)

#save it into a shapefile
working <- getwd()
writeOGR(map_df, 
         dsn = working, 
         layer= "map_df",
         driver="ESRI Shapefile")

plot(map_df)

TRI_nbq <- poly2nb(map_df)

coords <- coordinates(map_df)
plot(map_df)



spplot()

```

#Do GWR analysis by MODZCTA

```{r}

####----- 8 GWR ####
working <- getwd()
#Read in the data and create subsets for every R/E group and metal with no NAs
#we fist remove the NAs from the selected variable
map <- readOGR(dsn = working, layer ="map_df")
map_avg20 <- map_df[!is.na(map_df$wt_avg_2020) ,]
map_avg20 <- na.omit(map_avg20)

#create the adaptative bandwidth
bwG1 <- gwr.sel(wt_avg_2020 ~ positive , 
                data= map_df, 
               gweight=gwr.Gauss, verbose=TRUE, 
                adapt = F)
#run GWR with adaptative bandwith and with se and residuals, and global R2
gwr.1 = gwr(wt_avg_2020 ~ modzcta_cum_perc_pos , 
                data= map_df, 
                adapt=bwG1,
                hatmatrix=TRUE,
                se.fit=TRUE)
#double check the data
gwr.HISas
#save the estimates into a shapefile to plot in QGIS
names (gwr.HISas$SDF)
writeOGR(gwr.HISas$SDF, 
         dsn = working, 
         layer= "HISas_GWR",
         driver="ESRI Shapefile")

```

